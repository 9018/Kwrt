name: Build AX89X Firmware

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  build:
    name: Compile AX89X (qualcommax_ipq807x)
    runs-on: ubuntu-latest

    steps:
    - name: 🛎️ Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: true
        fetch-depth: 0

    - name: 🧰 Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential ccache ecj fastjar file g++ gawk \
          gettext git java-propose-classpath libncurses5-dev \
          libssl-dev python3 python3-distutils python3-setuptools \
          rsync unzip zlib1g-dev wget

    - name: 💾 Restore build cache
      uses: actions/cache@v3
      with:
        path: |
          dl
          build_dir
          staging_dir
          tmp
        key: ${{ runner.os }}-openwrt-${{ hashFiles('**/feeds.conf', 'devices/qualcommax_ipq807x/.config') }}

    - name: 📦 Update and install feeds
      run: |
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: ⚙️ Enable AX89X device in config
      run: |
        sed -i 's/CONFIG_TARGET_DEVICE_qualcommax_ipq807x_DEVICE_asus_rt-ax89x=n/CONFIG_TARGET_DEVICE_qualcommax_ipq807x_DEVICE_asus_rt-ax89x=y/' devices/qualcommax_ipq807x/.config
        cp devices/qualcommax_ipq807x/.config .config
        make defconfig

    - name: 🏗️ Build firmware
      run: |
        make -j$(nproc) V=s

    - name: 📤 Upload firmware artifacts
      uses: actions/upload-artifact@v4
      with:
        name: AX89X_firmware_${{ github.sha }}
        path: bin/targets/qualcommax/ipq807x/
        if-no-files-found: error